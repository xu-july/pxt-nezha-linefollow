{"entries":[{"timestamp":1771050482521,"editorVersion":"8.0.18","changes":[{"type":"edited","filename":"main.blocks","patch":[{"start1":0,"length1":133,"diffs":[[1,"<xml xmlns=\"http://www.w3.org/1999/xhtml\">\n  <block type=\"pxt-on-start\"></block>\n  <block type=\"device_forever\"></block>\n</xml>"]]}]},{"type":"edited","filename":"pxt.json","patch":[{"start1":109,"length1":149,"diffs":[[1,"        \"microphone\": \"*\"\n"]]},{"start1":199,"length1":41,"diffs":[[1,"        \"README.md\"\n"]]},{"start1":226,"length1":31,"diffs":[[1,"    \"additionalFilePaths\": []\n"]]}]},{"type":"added","filename":"custom.ts","value":"//% color=\"#00C04A\" weight=100 icon=\"\\uf1b9\" block=\"模拟灰度巡线控制\"\nnamespace AnalogLineFollow {\n    let _kp = 0;\n    let _ki = 0;\n    let _kd = 0;\n    let _prevError = 0;\n    let _integral = 0;\n\n    //% block=\"设置PID参数 Kp $p Ki $i Kd $d\"\n    //% p.defl=1.5 i.defl=0 d.defl=0.8\n    export function setPID(p: number, i: number, d: number): void {\n        _kp = p;\n        _ki = i;\n        _kd = d;\n        _integral = 0;\n        _prevError = 0;\n    }\n\n    //% block=\"平滑起步 目标速度 $targetSpeed 步进延迟(ms) $delayMs\"\n    //% targetSpeed.defl=50 delayMs.defl=20\n    export function smoothStart(targetSpeed: number, delayMs: number): void {\n        for (let s = 0; s <= targetSpeed; s += 5) {\n            neZha.setMotorSpeed(neZha.MotorList.M1, s);\n            neZha.setMotorSpeed(neZha.MotorList.M2, s);\n            basic.pause(delayMs);\n        }\n    }\n\n    //% block=\"平滑刹车 当前速度 $currentSpeed 步进延迟(ms) $delayMs\"\n    //% currentSpeed.defl=50 delayMs.defl=20\n    export function smoothBrake(currentSpeed: number, delayMs: number): void {\n        for (let s = currentSpeed; s >= 0; s -= 5) {\n            neZha.setMotorSpeed(neZha.MotorList.M1, s);\n            neZha.setMotorSpeed(neZha.MotorList.M2, s);\n            basic.pause(delayMs);\n        }\n        neZha.setMotorSpeed(neZha.MotorList.M1, 0);\n        neZha.setMotorSpeed(neZha.MotorList.M2, 0);\n    }\n\n    function getLineError(): number {\n        let l2_val = PlanetX_Basic.TrackbitgetGray(PlanetX_Basic.TrackbitChannel.One);\n        let l1_val = PlanetX_Basic.TrackbitgetGray(PlanetX_Basic.TrackbitChannel.Two);\n        let r1_val = PlanetX_Basic.TrackbitgetGray(PlanetX_Basic.TrackbitChannel.Three);\n        let r2_val = PlanetX_Basic.TrackbitgetGray(PlanetX_Basic.TrackbitChannel.Four);\n\n        let left_weight = (l2_val * 2) + l1_val;\n        let right_weight = (r2_val * 2) + r1_val;\n        let error = left_weight - right_weight;\n\n        return error / 100;\n    }\n\n    //% block=\"执行一次PID灰度巡线 基础速度 $baseSpeed\"\n    //% baseSpeed.defl=40\n    export function pidRun(baseSpeed: number): void {\n        let error = getLineError();\n\n        _integral += error;\n        let derivative = error - _prevError;\n        let adjustment = (_kp * error) + (_ki * _integral) + (_kd * derivative);\n\n        _prevError = error;\n\n        let leftSpeed = baseSpeed + adjustment;\n        let rightSpeed = baseSpeed - adjustment;\n\n        leftSpeed = Math.max(-100, Math.min(100, leftSpeed));\n        rightSpeed = Math.max(-100, Math.min(100, rightSpeed));\n\n        neZha.setMotorSpeed(neZha.MotorList.M1, leftSpeed);\n        neZha.setMotorSpeed(neZha.MotorList.M2, rightSpeed);\n    }\n}\n"}]},{"timestamp":1771051512681,"editorVersion":"8.0.18","changes":[{"type":"edited","filename":"custom.ts","patch":[{"start1":0,"length1":0,"diffs":[[1,"//% color=\"#00C04A\" weight=100 icon=\"\\uf1b9\" block=\"模拟灰度巡线控制\"\nnamespace AnalogLineFollow {\n    let _kp = 0;\n    let _ki = 0;\n    let _kd = 0;\n    let _prevError = 0;\n    let _integral = 0;\n\n    //% block=\"设置PID参数 Kp $p Ki $i Kd $d\"\n    //% p.defl=1.5 i.defl=0 d.defl=0.8\n    export function setPID(p: number, i: number, d: number): void {\n        _kp = p;\n        _ki = i;\n        _kd = d;\n        _integral = 0;\n        _prevError = 0;\n    }\n\n    //% block=\"平滑起步 目标速度 $targetSpeed 步进延迟(ms) $delayMs\"\n    //% targetSpeed.defl=50 delayMs.defl=20\n    export function smoothStart(targetSpeed: number, delayMs: number): void {\n        for (let s = 0; s <= targetSpeed; s += 5) {\n            neZha.setMotorSpeed(neZha.MotorList.M1, s);\n            neZha.setMotorSpeed(neZha.MotorList.M2, s);\n            basic.pause(delayMs);\n        }\n    }\n\n    //% block=\"平滑刹车 当前速度 $currentSpeed 步进延迟(ms) $delayMs\"\n    //% currentSpeed.defl=50 delayMs.defl=20\n    export function smoothBrake(currentSpeed: number, delayMs: number): void {\n        for (let s = currentSpeed; s >= 0; s -= 5) {\n            neZha.setMotorSpeed(neZha.MotorList.M1, s);\n            neZha.setMotorSpeed(neZha.MotorList.M2, s);\n            basic.pause(delayMs);\n        }\n        neZha.setMotorSpeed(neZha.MotorList.M1, 0);\n        neZha.setMotorSpeed(neZha.MotorList.M2, 0);\n    }\n\n    function getLineError(): number {\n        let l2_val = PlanetX_Basic.TrackbitgetGray(PlanetX_Basic.TrackbitChannel.One);\n        let l1_val = PlanetX_Basic.TrackbitgetGray(PlanetX_Basic.TrackbitChannel.Two);\n        let r1_val = PlanetX_Basic.TrackbitgetGray(PlanetX_Basic.TrackbitChannel.Three);\n        let r2_val = PlanetX_Basic.TrackbitgetGray(PlanetX_Basic.TrackbitChannel.Four);\n\n        let left_weight = (l2_val * 2) + l1_val;\n        let right_weight = (r2_val * 2) + r1_val;\n        let error = left_weight - right_weight;\n\n        return error / 100;\n    }\n\n    //% block=\"执行一次PID灰度巡线 基础速度 $baseSpeed\"\n    //% baseSpeed.defl=40\n    export function pidRun(baseSpeed: number): void {\n        let error = getLineError();\n\n        _integral += error;\n        let derivative = error - _prevError;\n        let adjustment = (_kp * error) + (_ki * _integral) + (_kd * derivative);\n\n        _prevError = error;\n\n        let leftSpeed = baseSpeed + adjustment;\n        let rightSpeed = baseSpeed - adjustment;\n\n        leftSpeed = Math.max(-100, Math.min(100, leftSpeed));\n        rightSpeed = Math.max(-100, Math.min(100, rightSpeed));\n\n        neZha.setMotorSpeed(neZha.MotorList.M1, leftSpeed);\n        neZha.setMotorSpeed(neZha.MotorList.M2, rightSpeed);\n    }\n}\n"]]}]}]},{"timestamp":1771051521614,"editorVersion":"8.0.18","changes":[{"type":"edited","filename":"main.blocks","patch":[{"start1":0,"length1":131,"diffs":[[1,"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables></variables><block type=\"pxt-on-start\" x=\"20\" y=\"20\"></block></xml>"]]}]},{"type":"edited","filename":"pxt.json","patch":[{"start1":370,"length1":35,"diffs":[[1,"    \"preferredEditor\": \"tsprj\"\n"]]}]},{"type":"edited","filename":"custom.ts","patch":[{"start1":0,"length1":3942,"diffs":[[1,""]]}]}]},{"timestamp":1771052199168,"editorVersion":"8.0.18","changes":[{"type":"edited","filename":"main.blocks","patch":[{"start1":0,"length1":133,"diffs":[[1,"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables></variables><block type=\"pxt-on-start\" x=\"0\" y=\"0\"></block></xml>"]]}]}]},{"timestamp":1771052202497,"editorVersion":"8.0.18","changes":[{"type":"edited","filename":"main.blocks","patch":[{"start1":0,"length1":501,"diffs":[[1,"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables></variables><block type=\"pxt-on-start\" x=\"65\" y=\"16\"></block></xml>"]]}]},{"type":"edited","filename":"main.ts","patch":[{"start1":0,"length1":133,"diffs":[[1,"\n"]]}]},{"type":"edited","filename":"pxt.json","patch":[{"start1":370,"length1":31,"diffs":[[1,"    \"preferredEditor\": \"blocksprj\"\n"]]}]},{"type":"edited","filename":"custom.ts","patch":[{"start1":190,"length1":0,"diffs":[[1,"    // 全局控制变量\n"]]},{"start1":229,"length1":20,"diffs":[[1,"    let _brake = 0;     // 弯道刹车系数\n"]]},{"start1":321,"length1":362,"diffs":[[1,"    //% block=\"初始化巡线 Kp $p Ki $i Kd $d 基础速度 $baseSpeed 弯道刹车系数 $brake\"\n"]]},{"start1":480,"length1":118,"diffs":[[1,"    export function setPID(p: number, i: number, d: number, baseSpeed: number, brake: number): void {\n"]]},{"start1":689,"length1":67,"diffs":[[1,""]]},{"start1":943,"length1":0,"diffs":[[1,"        // 自动计算当前速度（取左右轮平均值）\n"]]},{"start1":1047,"length1":0,"diffs":[[1,"\n        // 智能判断是需要\"加速\"还是\"减速\"\n"]]},{"start1":1133,"length1":0,"diffs":[[1,"        // 平滑过渡循环\n"]]},{"start1":1467,"length1":0,"diffs":[[1,"        // 终极安全锁：确保最后死死锁定在你要求的目标速度上\n"]]},{"start1":2445,"length1":856,"diffs":[[1,""]]},{"start1":2983,"length1":190,"diffs":[[1,"        return error / 100;\n"]]}]}]},{"timestamp":1771052801605,"editorVersion":"8.0.18","changes":[{"type":"edited","filename":"main.blocks","patch":[{"start1":0,"length1":131,"diffs":[[1,"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables></variables><block type=\"pxt-on-start\" x=\"0\" y=\"0\"><statement name=\"HANDLER\"><block type=\"PlanetX_Basic_Trackbit_get_state_value\"><next><block type=\"device_while\"><value name=\"COND\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">FALSE</field></shadow><block type=\"PlanetX_Basic_TrackbitState\"><field name=\"State\">PlanetX_Basic.TrackbitStateType.Tracking_State_1</field></block></value></block></next></block></statement></block></xml>"]]}]},{"type":"edited","filename":"main.ts","patch":[{"start1":0,"length1":1,"diffs":[[1,"PlanetX_Basic.Trackbit_get_state_value()\nwhile (PlanetX_Basic.TrackbitState(PlanetX_Basic.TrackbitStateType.Tracking_State_1)) {\n\t\n}\n"]]}]},{"type":"edited","filename":"pxt.json","patch":[{"start1":370,"length1":35,"diffs":[[1,"    \"preferredEditor\": \"tsprj\"\n"]]}]},{"type":"edited","filename":"custom.ts","patch":[{"start1":293,"length1":0,"diffs":[[1,"    // 新增：全局线色记忆\n"]]},{"start1":446,"length1":0,"diffs":[[1,"    // 新增：赛道颜色下拉菜单\n"]]},{"start1":969,"length1":50,"diffs":[[1,"        _isWhiteLine = (line === LineType.White); // 记住用户选的是白线还是黑线\n"]]},{"start1":3535,"length1":107,"diffs":[[1,"    function getLineError(): number {\n"]]},{"start1":3925,"length1":880,"diffs":[[1,""]]},{"start1":4103,"length1":0,"diffs":[[1,"        // --- 核心数学反转黑科技 ---\n        // 如果用户选择了\"白线(黑底)\"，把误差正负极颠倒，完美适配！\n"]]},{"start1":4241,"length1":0,"diffs":[[1,"        return error;\n    }\n\n    //% block=\"执行一次PID灰度巡线\"\n    //% weight=70\n    export function pidRun(): void {\n        let error = getLineError();\n\n"]]}]}]},{"timestamp":1771053343801,"editorVersion":"8.0.18","changes":[{"type":"edited","filename":"main.blocks","patch":[{"start1":0,"length1":157,"diffs":[[1,"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables></variables><block type=\"pxt-on-start\" x=\"0\" y=\"0\"></block></xml>"]]}]},{"type":"edited","filename":"pxt.json","patch":[{"start1":2,"length1":25,"diffs":[[1,"    \"name\": \"pid\",\n"]]},{"start1":370,"length1":44,"diffs":[[1,""]]}]},{"type":"added","filename":"test.ts","value":"// 在此处测试；当此软件包作为插件使用时，将不会编译此软件包。\n"}]}],"snapshots":[{"timestamp":1771050482520,"editorVersion":"8.0.18","text":{"main.blocks":"<xml xmlns=\"http://www.w3.org/1999/xhtml\">\n  <block type=\"pxt-on-start\"></block>\n  <block type=\"device_forever\"></block>\n</xml>","main.ts":"\n","README.md":"","pxt.json":"{\n    \"name\": \"pid\",\n    \"description\": \"\",\n    \"dependencies\": {\n        \"core\": \"*\",\n        \"radio\": \"*\",\n        \"microphone\": \"*\"\n    },\n    \"files\": [\n        \"main.blocks\",\n        \"main.ts\",\n        \"README.md\"\n    ],\n    \"additionalFilePaths\": []\n}\n"}},{"timestamp":1771052301992,"editorVersion":"8.0.18","text":{"main.blocks":"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables></variables><block type=\"pxt-on-start\" x=\"65\" y=\"16\"><statement name=\"HANDLER\"><block type=\"PlanetX_Basic_Trackbit_get_state_value\"></block></statement></block><block type=\"PlanetX_Basic_TrackbitState\" disabled-reasons=\"pxt_automatic_disabled\" x=\"350\" y=\"190\"><field name=\"State\">PlanetX_Basic.TrackbitStateType.Tracking_State_0</field></block></xml>","main.ts":"","README.md":"","custom.ts":"//% color=\"#00C04A\" weight=100 icon=\"\\uf1b9\" block=\"模拟灰度巡线控制\"\nnamespace AnalogLineFollow {\n    let _kp = 0;\n    let _ki = 0;\n    let _kd = 0;\n    let _prevError = 0;\n    let _integral = 0;\n\n    // 全局控制变量\n    let _baseSpeed = 40;\n    let _brake = 0;     // 弯道刹车系数\n    let _lastLeftSpeed = 0;\n    let _lastRightSpeed = 0;\n\n    //% block=\"初始化巡线 Kp $p Ki $i Kd $d 基础速度 $baseSpeed 弯道刹车系数 $brake\"\n    //% p.defl=1.5 i.defl=0 d.defl=0.8 baseSpeed.defl=40 brake.defl=5\n    //% weight=100\n    export function setPID(p: number, i: number, d: number, baseSpeed: number, brake: number): void {\n        _kp = p;\n        _ki = i;\n        _kd = d;\n        _baseSpeed = baseSpeed;\n        _brake = brake;\n        _integral = 0;\n        _prevError = 0;\n    }\n\n    //% block=\"平滑起步/变速 目标速度 $targetSpeed 步进延迟(ms) $delayMs\"\n    //% targetSpeed.defl=80 delayMs.defl=20\n    //% weight=90\n    export function smoothStart(targetSpeed: number, delayMs: number): void {\n        // 自动计算当前速度（取左右轮平均值）\n        let currentS = Math.round((_lastLeftSpeed + _lastRightSpeed) / 2);\n\n        // 智能判断是需要\"加速\"还是\"减速\"\n        let step = (targetSpeed >= currentS) ? 5 : -5;\n\n        // 平滑过渡循环\n        for (let s = currentS; (step > 0 ? s <= targetSpeed : s >= targetSpeed); s += step) {\n            neZha.setMotorSpeed(neZha.MotorList.M1, s);\n            neZha.setMotorSpeed(neZha.MotorList.M2, s);\n            _lastLeftSpeed = s;\n            _lastRightSpeed = s;\n            basic.pause(delayMs);\n        }\n\n        // 终极安全锁：确保最后死死锁定在你要求的目标速度上\n        neZha.setMotorSpeed(neZha.MotorList.M1, targetSpeed);\n        neZha.setMotorSpeed(neZha.MotorList.M2, targetSpeed);\n        _lastLeftSpeed = targetSpeed;\n        _lastRightSpeed = targetSpeed;\n    }\n\n    //% block=\"平滑刹车 步进延迟(ms) $delayMs\"\n    //% delayMs.defl=20\n    //% weight=80\n    export function smoothBrake(delayMs: number): void {\n        let steps = 10;\n        let leftStep = _lastLeftSpeed / steps;\n        let rightStep = _lastRightSpeed / steps;\n\n        for (let i = 0; i < steps; i++) {\n            _lastLeftSpeed -= leftStep;\n            _lastRightSpeed -= rightStep;\n            neZha.setMotorSpeed(neZha.MotorList.M1, _lastLeftSpeed);\n            neZha.setMotorSpeed(neZha.MotorList.M2, _lastRightSpeed);\n            basic.pause(delayMs);\n        }\n        neZha.setMotorSpeed(neZha.MotorList.M1, 0);\n        neZha.setMotorSpeed(neZha.MotorList.M2, 0);\n        _lastLeftSpeed = 0;\n        _lastRightSpeed = 0;\n    }\n\n    function getLineError(): number {\n        let l2_val = PlanetX_Basic.TrackbitgetGray(PlanetX_Basic.TrackbitChannel.One);\n        let l1_val = PlanetX_Basic.TrackbitgetGray(PlanetX_Basic.TrackbitChannel.Two);\n        let r1_val = PlanetX_Basic.TrackbitgetGray(PlanetX_Basic.TrackbitChannel.Three);\n        let r2_val = PlanetX_Basic.TrackbitgetGray(PlanetX_Basic.TrackbitChannel.Four);\n\n        let left_weight = (l2_val * 2) + l1_val;\n        let right_weight = (r2_val * 2) + r1_val;\n        let error = left_weight - right_weight;\n\n        return error / 100;\n    }\n\n    //% block=\"执行一次PID灰度巡线\"\n    //% weight=70\n    export function pidRun(): void {\n        let error = getLineError();\n\n        _integral += error;\n        let derivative = error - _prevError;\n        let adjustment = (_kp * error) + (_ki * _integral) + (_kd * derivative);\n\n        _prevError = error;\n\n        let curveSharpness = Math.abs(error);\n        let dynamicBaseSpeed = _baseSpeed - (curveSharpness * _brake);\n        dynamicBaseSpeed = Math.max(10, dynamicBaseSpeed);\n\n        let leftSpeed = dynamicBaseSpeed + adjustment;\n        let rightSpeed = dynamicBaseSpeed - adjustment;\n\n        leftSpeed = Math.max(-100, Math.min(100, leftSpeed));\n        rightSpeed = Math.max(-100, Math.min(100, rightSpeed));\n\n        _lastLeftSpeed = leftSpeed;\n        _lastRightSpeed = rightSpeed;\n\n        neZha.setMotorSpeed(neZha.MotorList.M1, leftSpeed);\n        neZha.setMotorSpeed(neZha.MotorList.M2, rightSpeed);\n    }\n}\n","pxt.json":"{\n    \"name\": \"pid\",\n    \"description\": \"\",\n    \"dependencies\": {\n        \"core\": \"*\",\n        \"radio\": \"*\",\n        \"microphone\": \"*\",\n        \"pxt-nezha\": \"github:elecfreaks/pxt-nezha#v1.3.10\",\n        \"pxt-PlanetX\": \"github:elecfreaks/pxt-planetx#v1.6.2\"\n    },\n    \"files\": [\n        \"main.blocks\",\n        \"main.ts\",\n        \"README.md\",\n        \"custom.ts\"\n    ],\n    \"preferredEditor\": \"blocksprj\"\n}\n"}}],"shares":[],"lastSaveTime":1771053818955}